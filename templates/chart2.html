<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Data Chart</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <div style="margin-left: 200px">
        <h2>Data Chart - Gabungan</h2>
        <canvas id="combinedChart" width="600" height="600"></canvas>
        <h2>Data Chart - pH</h2>
        <canvas id="phChart" width="600" height="600"></canvas>
        <h2>Data Chart - Suhu</h2>
        <canvas id="suhuChart" width="600" height="600"></canvas>
        <h2>Data Chart - Lembab</h2>
        <canvas id="lembabChart" width="600" height="600"></canvas>
    </div>
    <script>
        let combinedChart, phChart, suhuChart, lembabChart;

        async function fetchData() {
            const response = await fetch('/data');
            const data = await response.json();
            return data;
        }

        function createCombinedChart(ctx, data) {
            return new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.id_micro,
                    datasets: [
                        {
                            label: 'pH',
                            data: data.ph,
                            borderColor: 'rgba(75, 192, 192, 1)',
                            fill: false,
                        },
                        {
                            label: 'Suhu',
                            data: data.suhu,
                            borderColor: 'rgba(255, 99, 132, 1)',
                            fill: false,
                        },
                        {
                            label: 'Lembab',
                            data: data.lembab,
                            borderColor: 'rgba(54, 162, 235, 1)',
                            fill: false,
                        },
                    ],
                },
                options: {
                    responsive: false,
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'ID Micro',
                            },
                        },
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Value',
                            },
                        },
                    },
                },
            });
        }

        function createIndividualChart(ctx, labels, data, label, color) {
            return new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: label,
                            data: data,
                            borderColor: color,
                            fill: false,
                        },
                    ],
                },
                options: {
                    responsive: false,
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'ID Micro',
                            },
                        },
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Value',
                            },
                        },
                    },
                },
            });
        }

        async function updateChart() {
            const data = await fetchData();
            const combinedCtx = document.getElementById('combinedChart').getContext('2d');
            const phCtx = document.getElementById('phChart').getContext('2d');
            const suhuCtx = document.getElementById('suhuChart').getContext('2d');
            const lembabCtx = document.getElementById('lembabChart').getContext('2d');

            // Filter data for id_micro 2
            const filteredData = {
                id_micro: [],
                ph: [],
                suhu: [],
                lembab: [],
            };
            for (let i = 0; i < data.id_micro.length; i++) {
                if (data.id_micro[i] === 2) {
                    filteredData.id_micro.push(data.id_micro[i]);
                    filteredData.ph.push(data.ph[i]);
                    filteredData.suhu.push(data.suhu[i]);
                    filteredData.lembab.push(data.lembab[i]);
                }
            }

            // Destroy old charts if they exist
            if (combinedChart) combinedChart.destroy();
            if (phChart) phChart.destroy();
            if (suhuChart) suhuChart.destroy();
            if (lembabChart) lembabChart.destroy();

            // Create new charts
            combinedChart = createCombinedChart(combinedCtx, filteredData);
            phChart = createIndividualChart(
                phCtx,
                filteredData.id_micro,
                filteredData.ph,
                'pH dengan ID Micro 2',
                'rgba(75, 192, 192, 1)'
            );
            suhuChart = createIndividualChart(
                suhuCtx,
                filteredData.id_micro,
                filteredData.suhu,
                'Suhu dengan ID Micro 2',
                'rgba(255, 99, 132, 1)'
            );
            lembabChart = createIndividualChart(
                lembabCtx,
                filteredData.id_micro,
                filteredData.lembab,
                'Lembab dengan ID Micro 2',
                'rgba(54, 162, 235, 1)'
            );
        }

        updateChart();
        setInterval(updateChart, 10000); // Update every 5 seconds
    </script>
</body>

</html>